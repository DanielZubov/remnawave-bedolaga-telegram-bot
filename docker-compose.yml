services:
  postgres:
    image: postgres:15-alpine
    container_name: remnawave_bot_db
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-remnawave_bot}
      POSTGRES_USER: ${POSTGRES_USER:-remnawave_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-6e3489066ede55a96e9835429190c5d3}
      POSTGRES_INITDB_ARGS: '--encoding=UTF8 --locale=C'
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - bot_network # Внутренняя сеть для связи с ботом

  redis:
    image: redis:7-alpine
    container_name: remnawave_bot_redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    networks:
      - bot_network

  bot:
    image: ghcr.io/bedolaga-dev/remnawave-bedolaga-telegram-bot:latest # Используем готовый образ
    container_name: remnawave_bot
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_started
      redis:
        condition: service_started
    env_file:
      - .env
    networks:
      - bot_network # Для связи с БД и Redis
      - srv_proxy   # Для связи с Traefik
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=srv_proxy"
      # Используем путь вебхука из твоего .env
      - "traefik.http.routers.remnabot.rule=Host(`remnabot.hikamo.ru`) && (PathPrefix(`/webhook`) || PathPrefix(`/yookassa-webhook`) || PathPrefix(`/8527734458:AAEjUN-uSCtEmF0Vipqr0u_jEEV2bm3lMVQ`))"
      - "traefik.http.routers.remnabot.entrypoints=https"
      - "traefik.http.routers.remnabot.tls=true"
      - "traefik.http.routers.remnabot.tls.certresolver=cloudflare"
      - "traefik.http.services.remnabot.loadbalancer.server.port=8081" # Порт из твоего .env
      - "traefik.http.routers.remnabot.middlewares=hsts-header,compress"
      - "traefik.http.middlewares.hsts-header.headers.stsSeconds=15552000"
      - "traefik.http.middlewares.compress.compress=true"
    volumes:
      - ./logs:/app/logs:rw
      - ./locales:/app/locales:rw
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
      - ./vpn_logo.png:/app/vpn_logo.png:ro
    healthcheck:
      # Проверка порта 8081 (как в .env)
      test: ["CMD-SHELL", "python -c 'import requests; requests.get(\"http://localhost:8081/health\", timeout=5)' || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 3

volumes:
  postgres_data:
  redis_data:

networks:
  bot_network: # Внутренняя сеть
    driver: bridge
  srv_proxy: # Твоя сеть с Traefik
    external: true